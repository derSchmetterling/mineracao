---
title: "Análise Dados Retrospectivos"
subtitle: "Data: 16/05/2023"
format:
  html:
    embed-resources: true
    fontsize: 15pt
    theme: sandstone
    #code-fold: true
    echo: false
    number-sections: false
    code-tools: true
    toc: true
    df-print: paged
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Bibliotecas

```{r bibliotecas, warning=FALSE, message=FALSE}

library(lares)
library(ggplot2)
library(dplyr)
library(readxl)
library(GGally)
library(gamlss)
library(nnet)
```

# Amostragem e divisão treino e teste

```{r}
data <-  read_excel('ChoiceBehaviour.xlsx')
summary(data)
```

```{r}
#| echo: false
# set.seed(10727865)
# sampled_df <- sample_n(data, 2000)
# write.csv(sampled_df,'baseprincipal.csv', sep = '/t', row.names = F)
# 
# sampled_df <- data.frame(sampled_df)
# 
# sampled_df[c(1,2),]
```

```{r}
#| echo: false
# train_idx <- caret::createDataPartition(sampled_df$Resposta, p =0.7, list = FALSE)
# 
# train_df <- sampled_df[train_idx,]
# test_df <- sampled_df[-train_idx,]
# 
# write.csv(train_df,'basetreino.csv', sep = '/t', row.names = F)
# 
# write.csv(test_df,'baseteste.csv', sep = '/t', row.names = F)
```

# Análise Exploratória

## Descrição do problema

Temos um conjunto de dados referentes ao aluguel de três máquinas por agricultores, as colunas são referentes a:

-   **Regiao:** variável discreta representando local onde moram os agricultores

-   **Prima:** variável discreta representando valor que o agricultor precisa pagar para reparar a máquina

-   **CustoProduto:** variável inteira positiva representando custo estimado do maquinário no momento do aluguel pelo agricultor

-   **Pmaquinabase:** variável contínua positiva representando o preço do aluguel da máquina base para dar cobertura ao assegurado

-   **Pmaquina1:** variável contínua positiva representando o preço do aluguel da máquina 1 ofertado ao agricultor

-   **Pmaquina2:** variável contínua positiva representando o preço do aluguel da máquina 2 ofertado ao agricultor

-   **Pmaquina3:** variável contínua positiva representando o preço do aluguel da máquina 3 ofertado ao agricultor

-   **Cmaquina1:** variável contínua positiva representando o custo do aluguel da máquina 1 ofertado ao agricultor

-   **Cmaquina2:** variável contínua positiva representando o

    custo do aluguel da máquina 2 ofertado ao agricultor

-   **Cmaquina3:** variável contínua positiva representando o

    custo do aluguel da máquina 3 ofertado ao agricultor

-   **Resposta:** variável discreta, assume o valor de 0 quando o agricultor não aluga nenhum máquina ou o número relativa a qual máquina ele alugou (1,2, ou 3).

O agricultor conhece apenas o valor de reparo das máquina (Prima) e o preço de aluguel de cada uma (Pmaquina1,Pmaquina2,Pmaquina3), enquanto a companhia tem conhecimento de todas as variáveis. Assim, queremos construir um modelo que prediza se um determinado agricultor vai alugar alguma das máquinas oferecidas e qual máquina ele tem maior probabilidade de adquirir.

```{r}
data_train <-  read.csv('basetreino.csv')
data_test <-  read.csv('baseteste.csv')
data_train <- data_train %>% 
        mutate_at(vars(CustoProduto), as.integer) %>% 
        mutate_at(vars(Resposta), as.factor) %>% 
        filter(Resposta != '0')

head(data_train)
data_train
```

```{r}
freqs_df(data_train[, c('Id', 'Regiao', 'Prima')], plot = T)
```

Inicialmente vemos que não há valores faltantes nem no conjunte de treino nem no conjunto de teste

```{r}
library(VIM)
aggr(data_test, col = c('green','red'), numbers = TRUE, sortVars = TRUE, 
     labels = names(data_train), cex.axis = .5, gap = 2, 
     ylab = c("Proportion in variable","Proportion in dataset"))
```

## Correlações

Analisando a correlação linear entre as variáveis numéricas, notamos que as variáveis relativas ao custo das máquinas e o preço do aluguel estão fortemente relacionadas, como é de se esperar. Porém, é importante ressaltar como o custo de uma máquina está intimamente correlacionado com o preço de aluguel de outra ([*Pmaquina3*]{.underline} e *Cmaquina1* tem 0.82, por exemplo).

As variáveis *CustoProduto* e *Prima* foram as que apresentaram menor correlação com as outras, com coeficientes de menores ou iguais a 0.6, porém todas as correlações são estatisticamente diferentes de 0 ao nível de 5% de significância.

```{r}
#numeric <- c("AGE", "SENIORITY")
df_pearson<- data_train[, -c(1,2,12)]


correl<- cor(df_pearson, method = 'pearson')

testRes = corrplot::cor.mtest(df_pearson, conf.level = 0.95, method = 'pearson')

corrplot::corrplot(correl, p.mat = testRes$p, addCoef.col ='black',method = 'square', order = 'FPC', type = 'lower', insig = 'blank', number.cex=0.6)
```

Usando o coeficiente de Spearman e adicionando as covariáveis categóricas, nota-se como a *Regiao* tem correlação estatisticamente igual a zero com todas as outras covariáveis, à exceção de *Cmaquina3*, com quem tem um módulo baíxissimo. É interessante ver também que *CustoProduto* não apresenta correlação com a variável Resposta e, de modo, geral, todas as covariáveis tem correlação monotônica fraca com a variável dependente.

```{r, warning=FALSE}

df_spearman <- data_train %>% 
  mutate_at(vars(Resposta), as.integer)

correl<- cor(df_spearman, method = 'spearman')

testRes = corrplot::cor.mtest(df_spearman, conf.level = 0.95, method = 'spearman')

corrplot::corrplot(correl, p.mat = testRes$p, addCoef.col ='black',method = 'square', order = 'FPC', type = 'lower', insig = 'blank', number.cex=0.6)
```

```{python}
import pandas as pd
from sklearn.feature_selection import SelectKBest
from sklearn.feature_selection import f_classif


df = pd.read_excel('ChoiceBehaviour.xlsx')
df = df[df['Resposta'] != 0]
```

```{python}

x = df[1:9]
y = df[10]

fs = SelectKBest(score_func=f_classif, k=2)
# aplica o método
X_selected = fs.fit_transform(x, y)

```

## Distribuição da Variável Resposta

Analisando a variável relativa ao aluguel de máquinas pelos agricultores, vemos que a grande maioria deles não alugou nenhuma.

```{r}
hist_resp <- ggplot(data_train %>% count(Resposta) %>%    
         mutate(pct=n/sum(n)),
       aes(as.factor(Resposta), n)) +
  geom_bar(stat="identity", fill = 'purple') +
  #geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5)) +
  labs(x = 'Aluguel de Máquinas', y = 'Frequência Absoluta', title = "Distribuição de Resposta")

hist_resp
```

No total 144 indivíduos alugaram alguma das máquinas, sendo a máquina 2 a mais frequente.

```{r}
n_diff_zero <- nrow(filter(data_train, Resposta != 0))
n_a1 <- nrow(filter(data_train, Resposta == 1))
n_a2 <- nrow(filter(data_train, Resposta == 2))
n_a3 <- nrow(filter(data_train, Resposta == 3))


train <- c(nrow(data_train)-n_diff_zero,n_a1, n_a2, n_a3, n_diff_zero)



rent <-  data.frame(Alugadas = c(nrow(data_train)-n_diff_zero,n_a1, n_a2, n_a3, n_diff_zero),
                    row.names = c('Não alugou', 'Alugou 1','Alugou 2', 'Alugou 3', 'Total Alugadas'))

rent
```

### Resposta vs Custo

```{r}

hist_resp <- ggplot(data_train,
       aes(as.factor(Prima), Pmaquina1, colour = as.factor(Resposta) )) +
  geom_point(stat="identity") +
  #geom_text(aes(label=paste0(sprintf("%1.1f", pct*100),"%")), position=position_stack(vjust=0.5)) +
  scale_fill_manual(guide_legend(title="Aluguel de Máquinas"), values = c("#D95F02", "#1B9E77", "red", "blue")) + 
  labs(x = 'Aluguel de Máquinas', y = 'Frequência Absoluta', title = "Distribuição de Resposta")

hist_resp


```

## Redução de Dimensionalidade

```{r}
library("FactoMineR")
library("factoextra")
library(ggcorrplot)
```

```{r}

dropped_df <- data_train %>% 
  dplyr::select(-one_of(c('Regiao', 'Id', 'Resposta')))

data_normalized <- scale(dropped_df)
corr_matrix <- cor(data_normalized)

data.pca <- PCA(corr_matrix, scale = F, graph = F)


eigenvalues <- data.pca$eig
head(eigenvalues[, 1:2])

explained_var <- sum(eigenvalues[1:3, 2])
print(paste('Porcentagem da variância explicada por PCA 1,2 e 3: ', explained_var))



```

```{r}
sort(abs(data.pca$var$contrib[,1]), decreasing = TRUE)[1:5]
sort(abs(data.pca$var$contrib[,2]), decreasing = TRUE)[1:5]
sort(abs(data.pca$var$contrib[,3]), decreasing = TRUE)[1:5]



```

## Ajuste de Modelos

Usando as variáveis usadas para a construção das três componentes principais e excluindo aqueles com alta correlação linear entre si, terminamos com CustoProduto e Prima para predizer o tipo de máquina alugada.

```{r}
reduced_data1 <- data_train %>% 
  dplyr::select(one_of('CustoProduto', 'Resposta', 'Prima'))
```

```{r}

reduced_data1$Resposta2 <- relevel(reduced_data1$Resposta, ref = "0")


m1 <- multinom(Resposta2 ~ CustoProduto + Prima, data = reduced_data1)

summary(m1)

unique(predict(m1, newdata = reduced_data1, type = 'class'))


```
